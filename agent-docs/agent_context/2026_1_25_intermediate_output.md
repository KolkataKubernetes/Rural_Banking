# Execplan Procedure Goals

@./1_code/legacy/WI_report_descriptives.R entangles a set of data processing procedures with data visualization procedures. I would like to create an execplan that:

1) creates an R script that creates a set of intermediary data outputs. These outputs can then be used to create each of the data visualizations in @./1_code/1_2_visualize. Procedures should be included in a single R script titled "1_0_1_wi_descriptives.R" and located in @./1_code/1_1_transform.

2) Updates the scripts in @./1_code/1_1_visualize so the correct libraries are invoked, the correct intermediary data outputs are ingested into each script, such that the scripts run successfully.

3) Finally, create a markdown file that includes a dictionary mapping each figure to a filepath. Save this markdown file in @./agent-docs/agent_context. We will reference this markdown in later tasks to save on context, and have you easily translate mentions of "figure XX" to a specific filepath.

## Requirements

- Each script created or modified must include a preamble and comment structure consistent with `@./1_code/1_0_ingest/CORI_formd_new.R`.

- Scripts must preserve the statistical meaning of each figure (group definitions, weighting, aggregation rules, CRS, and units). Cosmetic differences are acceptable; semantic differences are not. All figures must reproduce the ggplot outputs previously generated in `@./1_code/legacy/WI_report_descriptives.R`, which should be treated as the authoritative reference.

- All scripts and outputs must follow the repositoryâ€™s naming conventions. `@./1_code/1_2_visualize` should be used as the reference standard.

- All intermediate data outputs must be generated by a single R script saved in `@./1_code/1_1_transform` and written to `@./2_processed_data`. Each intermediate output must be saved as a single `.rds` file containing exactly one data frame whose name matches the filename.

- Do not introduce new intermediate datasets or figures. Every intermediate output must correspond to a clearly identifiable transformation step used by at least one existing figure in `WI_report_descriptives.R`.

- Library usage in all scripts must be restricted to packages already used in `@./1_code/legacy/WI_report_descriptives.R`.

- Each script must be runnable in isolation. The intermediate script must run end-to-end without manual intervention, and all visualization scripts must assume the intermediate outputs already exist.

- After refactoring, verify that each visualization script executes without error using only the intermediate outputs. If a script cannot be made fully independent, document the reason explicitly in comments.

- When producing the figure-to-filepath markdown file (Procedure Goal 3), use the following format:

  | Figure ID | Description | Script | Output File |


## Failure Conditions

- If preserving the statistical meaning of a figure would require introducing a new intermediate dataset, the process must stop and the conflict must be documented before proceeding.

- If a visualization script cannot be made runnable using only the intermediate outputs, the refactor must halt and the dependency preventing isolation must be explicitly described.

- If reproducing a figure requires packages not already used in `WI_report_descriptives.R`, execution must stop and the missing dependency must be identified and justified.

- If there is ambiguity about how an intermediate output maps to an existing figure or transformation step, do not guess. Pause and request clarification.

- Do not proceed past any step that would violate the above Requirements, even if a partial or approximate solution appears possible.

## Comments for additional context
- It's possible that a few additional data pre-processing steps should be added to a few of the scripts to enable better transparency with respect to both figure creation and the intermediate outputs. For example, consider figures 11 and 12. Both figures contain significant pre-processing steps for calculating group averages. As a general, if a pre-processing script is shared across scripts, we should have it included in the the R script that creates a set of intermediary data outputs. In some cases - this might not be feasible (you will likely need to recreate the map objects for each fig within each viz script). I will let you exercise some discretion with respect to code design choice based on this tradeoff.

## Success Criteria / Acceptance Checks

- **Build passes end-to-end:** Running the intermediate script (`@./1_code/1_1_transform/1_0_1_wi_descriptives.R`) completes without error on a clean session and writes all expected `.rds` outputs to `@./2_processed_data`.

- **Viz scripts run in isolation:** Each script in `@./1_code/1_2_visualize` runs from a clean R session without error after the intermediate script has been run, and does not perform data-wrangling that belongs in the intermediate script (beyond figure-specific formatting or map-object recreation).

- **No new figures / intermediates:** The set of figures produced and the set of intermediate outputs correspond one-to-one with what is required to reproduce the figures in `@./1_code/legacy/WI_report_descriptives.R`. No additional figures or intermediate datasets are introduced.

- **Output integrity (semantic equivalence):** For each figure, the refactored version matches the legacy version in:
  - the underlying row counts used to plot (or documented, justified differences),
  - group definitions and aggregation logic,
  - weighting (if any),
  - units and transformations,
  - CRS and geometry handling for maps.
  Cosmetic styling differences are acceptable.

- **Intermediate output contract:** Every intermediate output is a single `.rds` containing exactly one data frame object whose name matches the filename. No lists, no multiple objects.

- **Dependency discipline:** Each refactored/created script loads only packages already used in `@./1_code/legacy/WI_report_descriptives.R`, and each script loads only what it uses (no unused library calls).

- **Naming and documentation compliance:** All created/modified scripts and outputs follow repo naming conventions and include the required preamble/comment structure.

- **Figure index completeness:** The markdown dictionary in `@./agent-docs/agent_context` exists, uses the required table format, and includes an entry for every figure with correct paths for:
  - the visualization script, and
  - the final output file written by that script.

## USER CHANGE -  Updated filepaths to deal with network latency (1/25/2026):

Pitchbook Data: '@./0_inputs/formd_years'


Yearly Form D Data: '@./2_processed_data/formd_years'
