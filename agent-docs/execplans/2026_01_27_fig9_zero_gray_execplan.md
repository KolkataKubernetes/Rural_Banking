# Gray zero-count counties in Figure 9

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds.

This document must be maintained in accordance with `agent-docs/PLANS.md` from the repository root.

## Purpose / Big Picture

After this change, Figure 9 (Form D filing count by Wisconsin county) will visually distinguish counties with zero filings by graying them out, while still showing low-but-nonzero counts using the existing color scale. This improves interpretability by separating true zero-count counties from low-count counties.

## Progress

- [x] (2026-01-27 00:15Z) Review Figure 9 data flow and current fill scale behavior.
- [x] (2026-01-27 00:20Z) Implement zero-count detection and grey-out logic in the Figure 9 script.
- [x] (2026-01-27 00:25Z) Regenerate Figure 9 output and confirm expected visual behavior (user verified).
- [x] (2026-01-27 00:30Z) Update this ExecPlan with outcomes and any discoveries.

## Surprises & Discoveries

- Observation: Figure 9 script could not write the output file to the external `test_figures` directory in this environment.
  Evidence: `Warning message: In grDevices::dev.off() : agg could not write to the given file`

## Decision Log

- Decision: Treat `num_funded_entities == 0` as the explicit condition to gray out counties in Figure 9.
  Rationale: Figure 9’s data source is the CORI map JSON and `num_funded_entities` is the filing count field.
  Date/Author: 2026-01-27 / Codex

## Outcomes & Retrospective

Figure 9 now greys out zero-count counties by masking `num_funded_entities == 0` to `NA`, and the subtitle clarifies the visual encoding. The user confirmed the updated map meets the spec.

## Context and Orientation

Figure 9 is generated by `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R`. The script reads `0_inputs/upstream/formd-interactive-map/src/data/formd_map.json`, filters to Wisconsin counties by `name_co` ending with “WI,” and joins to tigris county geometry using `geoid_co` → `GEOID`. The map currently fills by `num_funded_entities` using `scale_fill_viridis_c` with `na.value = "grey90"`. The goal is to explicitly set counties with `num_funded_entities == 0` to render in grey, while keeping low nonzero values in the color scale.

## Plan of Work

Update `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R` to add a derived fill column that is `NA` for zero-count counties and equal to the count for nonzero counties. This allows the existing `na.value = "grey90"` to gray out only true zeros. Keep the legend tied to the nonzero values only. Update the caption or subtitle if needed to clarify that grey indicates zero filings.

## Concrete Steps

All commands run from the repository root: `/Users/indermajumdar/Research/Rural_Banking`.

1) Edit `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R` to:
   - Add a `fill_count` column such as:
     - `fill_count = if_else(num_funded_entities == 0, NA_real_, num_funded_entities)`
   - Replace the `geom_sf(aes(fill = num_funded_entities), ...)` mapping with `fill = fill_count`.
   - (Optional) Update subtitle or caption to note that grey counties have zero filings.

2) Run:

   Rscript 1_code/1_2_visualize/1_2_9_deals_cum_fig9.R

Expected transcript excerpt (example):

   > [1] "Saving 7 x 4.2 in image"

## Validation and Acceptance

Acceptance is met when:

- Counties with `num_funded_entities == 0` render in grey (same as `na.value` in the scale).
- Counties with small but nonzero counts display a color from the `viridis` scale.
- The figure still saves to `/Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/9_total_deals_cumulative.jpeg` without errors.

Sanity checks:

- Compare the new output to the previous version and verify that at least some counties with capital raised but zero filings are now greyed out.
- Confirm that the legend excludes a “0” bucket if the scale is continuous and zero has been masked to `NA`.

## Idempotence and Recovery

The change is safe to re-run; it only modifies how the fill values are mapped. If it produces unintended grey-out behavior, revert the `fill_count` logic to use the original `num_funded_entities` mapping.

## Artifacts and Notes

Expected output file:

  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/9_total_deals_cumulative.jpeg

## Data Contracts, Inputs, and Dependencies

- `0_inputs/upstream/formd-interactive-map/src/data/formd_map.json`:
  - Used by `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R`.
  - Required properties: `name_co`, `geoid_co`, `num_funded_entities`.
  - Output: map with counties filled by nonzero counts, zeros as `NA` to show grey.

- R packages:
  - `tidyverse`, `jsonlite`, `sf`, `scales` as already used in the script.

## Change Notes

- 2026-01-27: Initial ExecPlan created for zero-count county grey-out behavior in Figure 9.
- 2026-01-27: Implemented the zero-count mask and noted write-permission block on output regeneration.
- 2026-01-27: Marked plan complete after user confirmation that the map meets the spec.
