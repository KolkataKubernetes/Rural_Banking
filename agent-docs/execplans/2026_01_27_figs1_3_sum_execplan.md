# Reconfigure Figures 1–3 to use summed totals across years

This ExecPlan is a living document. The sections `Progress`, `Surprises & Discoveries`, `Decision Log`, and `Outcomes & Retrospective` must be kept up to date as work proceeds.

This document must be maintained in accordance with `agent-docs/PLANS.md` from the repository root.

## Purpose / Big Picture

After this change, Figures 1–3 will show totals summed across 2015–2025 (rather than averages). Figure 1 and Figure 2 will use summed deal counts and summed capital committed across years, and Figure 3 will recompute deal size as the ratio of summed capital committed to summed deal count. Figure 9’s legend will be reconfigured so counties above 100 filings are a distinct color, while values 1–100 use a continuous color scale. Figures 11, 12, and 18 will be redefined to use “per capita over the full period” logic: sum numerators across years by group, sum denominators across years, then take the quotient (with Figure 11 scaled per 100,000 workers). This provides a clearer total-period view for figures 1–3 and improves interpretability for figure 9 while aligning figures 11/12/18 with the revised estimand.

## Progress

- [x] (2026-01-27 01:00Z) Review the figure feedback and confirm the year range and labeling for the summed totals.
- [x] (2026-01-27 01:05Z) Update Figures 1–2 to sum across years and adjust labels/captions.
- [x] (2026-01-27 01:10Z) Update Figure 3 to compute deal size as summed volume divided by summed count across years.
- [x] (2026-01-27 01:15Z) Update Figure 9 legend to separate values above 100 from the 1–100 scale.
- [x] (2026-01-27 01:25Z) Update Figures 11, 12, and 18 to use summed numerators and denominators across years and recompute per-capita outputs.
- [ ] (2026-01-27 01:30Z) Run updated scripts and confirm outputs in `test_figures` (blocked: write permission).
- [x] (2026-01-27 01:35Z) Update this ExecPlan with outcomes and any discoveries.

## Surprises & Discoveries

- Observation: Figure scripts could not write outputs to the external `test_figures` directory in this environment.
  Evidence: `Warning message: In grDevices::dev.off() : agg could not write to the given file`
- Observation: RUCC-based metro/rural rule (RUCC 1–3 = metro) does not perfectly match the CORI JSON `rurality` field for WI counties.
  Evidence: 70/72 WI counties match; mismatches are Lincoln County (55069, JSON Metro vs RUCC 6 Nonmetro) and Vernon County (55123, JSON Nonmetro vs RUCC 3 Metro).

## Decision Log

- Decision: Use 2015–2025 inclusive for totals in Figures 1–3.
  Rationale: User confirmed the same range as current.
  Date/Author: 2026-01-27 / Codex

- Decision: Keep the single x-axis label for Figures 1–3 unchanged for now, but set the subtitle to “2015–2025 total.”
  Rationale: User requested to keep x-axis labels and explicitly set the subtitle.
  Date/Author: 2026-01-27 / Codex

- Decision: Keep percent-of-national labels/caption logic unchanged for Figures 1–3.
  Rationale: User confirmed captions should still reflect percent of national metric.
  Date/Author: 2026-01-27 / Codex

## Outcomes & Retrospective

Figures 1–3, 9, 11, 12, and 18 were updated per the spec, but output regeneration to `test_figures` was blocked by write permissions. Rerun is required in an environment with access to `/Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures`.
Open items remain for final review/approval; revisit and finalize this plan after the next visual QA pass.

## Context and Orientation

Figures 1–3 are generated by `1_code/1_2_visualize/1_2_1_vc_dealcount_fig1.R`, `1_code/1_2_visualize/1_2_2_vc_dealvol_fig2.R`, and `1_code/1_2_visualize/1_2_3_vc_dealsize_fig3.R`. They read intermediate RDS files from `2_processed_data` (`count_ts_data.rds` and `vol_ts_data.rds`) and currently produce single-category bar charts for the 2015–2025 average. This change replaces the mean aggregation with summed totals over the same years, and updates titles/subtitles/captions to reflect totals. Figure 9 is generated by `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R` and uses the CORI map JSON to display county filing counts; its legend needs reconfiguration to separate values above 100 from the 1–100 scale.

Figure 11 is generated by `1_code/1_2_visualize/1_2_11_incremental_formD_perlf_fig11.R` and currently uses per-labor-force values averaged across years. Figure 12 is generated by `1_code/1_2_visualize/1_2_12_dealcount_fig12.R` and currently averages per-year totals. Figure 18 is generated by `1_code/1_2_visualize/1_2_18_formd_dealsize_avg_fig18.R` and currently averages per-year deal sizes. The new requirement is to sum numerators and denominators across years (2016–2025), then compute the ratio once per group for the full period. Figure 11 must scale to per 100,000 workers and update the caption to “How much Form D capital per worker was raised over 2016–2025?”.

## Plan of Work

First, update Figure 1 to filter the input data to the target year range and sum `dealcount_national`, `dealcount_national_nonoutlier`, `dealcount_midwest`, and `dealcount_wi` across years. Replace the current average computation with summed totals, and keep the single x-axis category label as currently implemented. Update the subtitle and caption to reflect totals.

Second, update Figure 2 in the same way: filter to the year range, sum `dealvol_*` fields across years, and update labels to indicate total capital committed. Keep the single x-axis category label as currently implemented.

Third, update Figure 3 to recompute deal size as (sum of capital committed across years) divided by (sum of deal counts across years), using the same inputs as Figures 1 and 2. Update labels to reflect totals-based calculation.

Fourth, update Figure 9’s legend by splitting the data into two ranges: values 1–100 use a continuous color scale, and values above 100 use a single high-contrast color. Implement this by creating a categorical flag for `num_funded_entities > 100` and either (a) using two-layer `geom_sf` (one for 1–100 with viridis scale and one for >100 with a fixed fill), or (b) using `scale_fill_steps` with a manual top bin color if it cleanly produces the requested legend. Preserve the existing grey-out of zero values.

Fifth, update Figure 11 to compute per-capita totals over 2016–2025 by summing the numerator across years by group, summing the denominator across years across groups, then taking the quotient and scaling per 100,000 workers. Update subtitle/caption to reflect “per worker over 2016–2025.”

Sixth, update Figure 12 to sum the numerator and denominator separately across years (2016–2025), then divide to compute the total-period rate. Update labels to reflect totals across the period.

Seventh, update Figure 18 to sum the numerator and denominator separately across years (2016–2025), then divide to compute the total-period deal size. Update labels to reflect totals across the period.

Finally, run the three scripts and verify that the outputs are written to the `test_figures` folder.

## Concrete Steps

All commands run from the repository root: `/Users/indermajumdar/Research/Rural_Banking`.

1) Edit the following files:
   - `1_code/1_2_visualize/1_2_1_vc_dealcount_fig1.R`
   - `1_code/1_2_visualize/1_2_2_vc_dealvol_fig2.R`
   - `1_code/1_2_visualize/1_2_3_vc_dealsize_fig3.R`
   - `1_code/1_2_visualize/1_2_9_deals_cum_fig9.R`
   - `1_code/1_2_visualize/1_2_11_incremental_formD_perlf_fig11.R`
   - `1_code/1_2_visualize/1_2_12_dealcount_fig12.R`
   - `1_code/1_2_visualize/1_2_18_formd_dealsize_avg_fig18.R`

2) Run:

   Rscript 1_code/1_2_visualize/1_2_1_vc_dealcount_fig1.R
   Rscript 1_code/1_2_visualize/1_2_2_vc_dealvol_fig2.R
   Rscript 1_code/1_2_visualize/1_2_3_vc_dealsize_fig3.R
   Rscript 1_code/1_2_visualize/1_2_9_deals_cum_fig9.R
   Rscript 1_code/1_2_visualize/1_2_11_incremental_formD_perlf_fig11.R
   Rscript 1_code/1_2_visualize/1_2_12_dealcount_fig12.R
   Rscript 1_code/1_2_visualize/1_2_18_formd_dealsize_avg_fig18.R

Expected transcript excerpt (example):

   > [1] "Saving 16.5 x 5.5 in image"

## Validation and Acceptance

Acceptance is met when:

- Figure 1 shows summed deal counts over the full period, not the average; subtitle and captions indicate totals.
- Figure 2 shows summed capital committed over the full period; subtitle and captions indicate totals.
- Figure 3 deal size is computed as total capital committed divided by total deal count over the full period.
- The x-axis shows the single category label currently used in the scripts, and the subtitle explicitly reads “2015–2025 total.”
- Figure 9’s legend shows a distinct color for values above 100 and a continuous scale for values 1–100, while zero values remain greyed out.
- Figure 11 reflects total Form D capital per worker over 2016–2025, scaled per 100,000 workers, with the caption explicitly stating the per-worker framing.
- Figures 12 and 18 reflect total-period rates based on summed numerators and denominators across 2016–2025.
- Outputs are written to `/Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures`.

Sanity checks:

- Summed values should be larger than any single-year value previously plotted.
- Percent-of-national labels should still be computed relative to the national total across years.

## Idempotence and Recovery

The change is safe to rerun. If the totals view is not desired, revert the aggregation logic to the average-by-year calculations.

## Artifacts and Notes

Expected output files:

  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/1_vc_dealcount.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/2_vc_capcommitted.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/3_vc_dealsize.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/9_total_deals_cumulative.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/11_incremental_formD_per_lf_avg.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/12_formD_dealcount_avg.jpeg
  /Users/indermajumdar/Documents/Research/Rural Banking/2025_WI_report/test_figures/18_formD_dealsize_avg.jpeg

## Data Contracts, Inputs, and Dependencies

- `2_processed_data/count_ts_data.rds`:
  - Used by `1_code/1_2_visualize/1_2_1_vc_dealcount_fig1.R`.
  - Required columns: `year`, `dealcount_national`, `dealcount_national_nonoutlier`, `dealcount_midwest`, `dealcount_wi`.
  - Output: total deal counts across the selected years.

- `2_processed_data/vol_ts_data.rds`:
  - Used by `1_code/1_2_visualize/1_2_2_vc_dealvol_fig2.R`.
  - Required columns: `year`, `dealvol_national`, `dealvol_national_nonoutlier`, `dealvol_midwest`, `dealvol_wi`.
  - Output: total capital committed across the selected years.

- Figure 3 computation:
  - Uses the same `count_ts_data.rds` and `vol_ts_data.rds` inputs.
  - Output: total-period deal size per series computed as sum(volume)/sum(count).

- Figure 9 legend configuration:
  - Uses `num_funded_entities` from the CORI map JSON.
  - Output: continuous color scale for counts 1–100, and a high-contrast distinct color for counts above 100; zero values remain grey via `NA`.

- Figures 11/12/18 total-period logic:
  - Use `2_processed_data/adj_all.rds` and `2_processed_data/cnt_all.rds` for figures 11 and 12.
  - Use `2_processed_data/vol_all.rds` and `2_processed_data/cnt_all.rds` for figure 18.
  - Output: numerator and denominator summed across 2016–2025, then divided to produce total-period per-capita/per-deal-size metrics.

## Change Notes

- 2026-01-27: Initial ExecPlan created based on `agent-docs/agent_context/2026_1_27_IM_figure_feedback.md`.
- 2026-01-27: Updated ExecPlan with confirmed year range, subtitle guidance, and Figure 9 legend split requirements (high-contrast >100 color).
- 2026-01-27: Expanded ExecPlan to include Figures 11, 12, and 18 total-period estimand updates.
- 2026-01-27: Marked implementation complete; noted write-permission block on output regeneration.
- 2026-01-27: Documented RUCC vs CORI JSON rurality mismatch (2 WI counties) for future reference.
- 2026-01-27: Marked plan closed for now with a note to revisit and finalize after review.
